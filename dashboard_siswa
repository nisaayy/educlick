<?php
session_start();
error_reporting(E_ALL);
ini_set('display_errors', 1);

// Proteksi: hanya siswa yang boleh akses
if (!isset($_SESSION['role']) || $_SESSION['role'] !== 'siswa') {
    header("Location: ../index.php");
    exit;
}

if (!isset($_SESSION['id'])) {
    header("Location: ../index.php");
    exit;
}

require_once '../config/db.php';

$siswa_id = $_SESSION['id'];
$siswa_nama = $_SESSION['nama'] ?? 'Siswa';
$siswa_kelas = $_SESSION['kelas'] ?? '';

// Ambil foto profil dari database
$stmt = $conn->prepare("SELECT foto_profil FROM siswa WHERE id = ?");
$stmt->bind_param("i", $siswa_id);
$stmt->execute();
$result = $stmt->get_result()->fetch_assoc();
$stmt->close();

$foto_profil = $result['foto_profil'] ?? 'default.png';
$foto_path = '../uploads/profil/' . $foto_profil;

// Cek jika file foto tidak ada, gunakan default
if (!file_exists($foto_path) || empty($foto_profil)) {
    $foto_path = '../uploads/profil/default.png';
    if (!file_exists($foto_path)) {
        $foto_path = 'data:image/svg+xml;base64,' . base64_encode('
            <svg width="100" height="100" xmlns="http://www.w3.org/2000/svg">
                <rect width="100" height="100" fill="#2196F3"/>
                <text x="50" y="55" font-family="Arial" font-size="40" fill="white" text-anchor="middle" dominant-baseline="middle">' . strtoupper(substr($siswa_nama, 0, 1)) . '</text>
            </svg>
        ');
    }
}

// Helper nama hari
function hariID($timestamp = null) {
    $map = [1=>'Senin',2=>'Selasa',3=>'Rabu',4=>'Kamis',5=>'Jumat',6=>'Sabtu',7=>'Minggu'];
    return $map[intval(date('N', $timestamp ?? time()))] ?? '';
}

$hari_ini = hariID();
$tanggal_sql = date('Y-m-d');

// ==================== INFORMASI DARI ADMIN ====================
$sql_informasi = "
    SELECT * FROM informasi 
    WHERE (ditujukan = 'siswa' OR ditujukan = 'umum')
    AND tanggal >= DATE_SUB(NOW(), INTERVAL 24 HOUR)
    ORDER BY tanggal DESC LIMIT 3";
$informasi_result = $conn->query($sql_informasi);
$informasi_list = $informasi_result ? $informasi_result->fetch_all(MYSQLI_ASSOC) : [];

// ==================== STATISTIK SISWA ====================

// 1) Total kehadiran bulan ini
$bulan_ini = date('Y-m');
$stmt = $conn->prepare("
    SELECT 
        COUNT(*) as total_hadir,
        SUM(CASE WHEN status = 'Hadir' THEN 1 ELSE 0 END) as hadir,
        SUM(CASE WHEN status = 'Sakit' THEN 1 ELSE 0 END) as sakit,
        SUM(CASE WHEN status = 'Izin' THEN 1 ELSE 0 END) as izin,
        SUM(CASE WHEN status = 'Alpha' THEN 1 ELSE 0 END) as alpha
    FROM absensi 
    WHERE id_siswa = ? AND DATE_FORMAT(tanggal, '%Y-%m') = ?
");
$stmt->bind_param("is", $siswa_id, $bulan_ini);
$stmt->execute();
$res = $stmt->get_result()->fetch_assoc();
$total_kehadiran = $res['total_hadir'] ?? 0;
$hadir_bulan = $res['hadir'] ?? 0;
$sakit_bulan = $res['sakit'] ?? 0;
$izin_bulan = $res['izin'] ?? 0;
$alpha_bulan = $res['alpha'] ?? 0;
$stmt->close();

// 2) Jadwal hari ini
$stmt = $conn->prepare("
    SELECT j.*, m.nama_mapel, g.nama as nama_guru
    FROM jadwal j
    LEFT JOIN mapel m ON j.id_mapel = m.id
    LEFT JOIN guru g ON j.id_guru = g.id
    LEFT JOIN siswa s ON j.id_kelas = s.id_kelas
    WHERE s.id = ? AND j.hari = ?
    ORDER BY j.jam_mulai
");
$stmt->bind_param("is", $siswa_id, $hari_ini);
$stmt->execute();
$jadwal_hari_ini = $stmt->get_result()->fetch_all(MYSQLI_ASSOC);
$stmt->close();

// 3) Mata pelajaran total
$stmt = $conn->prepare("
    SELECT COUNT(DISTINCT j.id_mapel) as total_mapel
    FROM jadwal j
    LEFT JOIN siswa s ON j.id_kelas = s.id_kelas
    WHERE s.id = ?
");
$stmt->bind_param("i", $siswa_id);
$stmt->execute();
$res = $stmt->get_result()->fetch_assoc();
$total_mapel = $res['total_mapel'] ?? 0;
$stmt->close();

// 4) Absensi hari ini
$stmt = $conn->prepare("
    SELECT a.status, m.nama_mapel
    FROM absensi a
    LEFT JOIN mapel m ON a.id_mapel = m.id
    WHERE a.id_siswa = ? AND a.tanggal = ?
    ORDER BY a.id DESC
    LIMIT 3
");
$stmt->bind_param("is", $siswa_id, $tanggal_sql);
$stmt->execute();
$absensi_hari_ini = $stmt->get_result()->fetch_all(MYSQLI_ASSOC);
$stmt->close();

// Persentase kehadiran
$persentase_hadir = $total_kehadiran > 0 ? round(($hadir_bulan / $total_kehadiran) * 100, 1) : 0;
?>

<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Siswa - SDIT</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root{
  --orange: #FF9D4D;
  --orange-dark: #f68c2e;
  --green: #7FB069;
  --green-dark: #4d6651;
  --green-light: #A8D5BA;
  --bg: #F5F5F5;
  --white: #FFFFFF;
  --text-dark: #2D3748;
  --text-light: #718096;
  --shadow: 0 2px 8px rgba(0,0,0,0.08);
  --shadow-lg: 0 4px 16px rgba(0,0,0,0.12);
}

*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:'Poppins',sans-serif;
  background:var(--bg);
  color:var(--text-dark);
  -webkit-font-smoothing:antialiased;
  padding-bottom:80px;
}

/* Container */
.container{
  max-width:1200px;
  margin:0 auto;
  padding:0;
}

/* Header dengan kurva */
.header-wrapper{
  background:linear-gradient(135deg, var(--orange-dark) 0%, var(--orange) 100%);
  padding:24px 20px 60px;
  border-radius:0 0 40px 40px;
  box-shadow:var(--shadow-lg);
  margin-bottom:-40px;
  position:relative;
  z-index:1;
}
.header-content{
  max-width:1200px;
  margin:0 auto;
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
  color:var(--white);
}
.header-avatar{
  width:90px;
  height:90px;
  border-radius:50%;
  overflow:hidden;
  background:var(--white);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  color:var(--orange);
  font-size:36px;
  box-shadow:0 8px 24px rgba(0,0,0,0.2);
  border:4px solid var(--white);
  margin-bottom:12px;
}
.header-avatar img{
  width:100%;
  height:100%;
  object-fit:cover;
}
.header-info h3{
  font-size:22px;
  font-weight:700;
  margin-bottom:4px;
}
.header-info p{
  font-size:14px;
  opacity:0.95;
}

/* Main content area */
.main-content{
  padding:20px;
  position:relative;
  z-index:2;
}

/* Stats Cards */
.stats-section{
  display:grid;
  grid-template-columns:repeat(3, 1fr);
  gap:12px;
  margin-bottom:20px;
}
.stat-card{
  background:var(--white);
  border-radius:16px;
  padding:16px;
  box-shadow:var(--shadow);
  display:flex;
  align-items:center;
  gap:12px;
}
.stat-icon{
  width:48px;
  height:48px;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  flex-shrink:0;
}
.stat-icon.green{background:#E8F5E9;color:var(--green-dark)}
.stat-icon.orange{background:#FFF3E0;color:var(--orange-dark)}
.stat-icon.blue{background:#E3F2FD;color:#2196F3}
.stat-content h4{
  font-size:12px;
  color:var(--text-light);
  font-weight:500;
  margin-bottom:4px;
}
.stat-content p{
  font-size:16px;
  font-weight:700;
  color:var(--text-dark);
}

/* Urgent Info */
.urgent-info{
  background:linear-gradient(135deg, var(--orange-dark) 0%, var(--orange) 100%);
  border-radius:16px;
  padding:20px;
  margin-bottom:20px;
  color:var(--white);
  box-shadow:var(--shadow-lg);
}
.urgent-info h3{
  font-size:14px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:0.5px;
  margin-bottom:8px;
}
.urgent-info p{
  font-size:13px;
  line-height:1.5;
  opacity:0.95;
}

/* Quick Access */
.quick-access{
  margin-bottom:20px;
}
.quick-access h3{
  font-size:16px;
  font-weight:600;
  margin-bottom:12px;
  color:var(--text-dark);
}
.quick-buttons{
  display:grid;
  grid-template-columns:repeat(3, 1fr);
  gap:12px;
}
.quick-btn{
  background:var(--white);
  border-radius:16px;
  padding:20px 16px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:8px;
  text-decoration:none;
  box-shadow:var(--shadow);
  transition:all 0.3s ease;
}
.quick-btn:hover{
  transform:translateY(-4px);
  box-shadow:var(--shadow-lg);
}
.quick-btn.green{color:var(--green-dark)}
.quick-btn.orange{color:var(--orange-dark)}
.quick-btn.blue{color:#2196F3}
.quick-btn i{
  font-size:32px;
}
.quick-btn span{
  font-size:13px;
  font-weight:600;
}

/* Progress Kehadiran */
.progress-container{
  background:var(--white);
  border-radius:16px;
  padding:20px;
  box-shadow:var(--shadow);
  margin-bottom:20px;
}
.progress-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:16px;
}
.progress-header h4{
  font-size:15px;
  color:var(--text-dark);
  font-weight:600;
  display:flex;
  align-items:center;
  gap:8px;
}
.progress-percentage{
  font-size:24px;
  font-weight:700;
  color:var(--orange);
}
.progress-bar{
  width:100%;
  height:12px;
  background:#E0E0E0;
  border-radius:10px;
  overflow:hidden;
  margin-bottom:16px;
}
.progress-fill{
  height:100%;
  background:linear-gradient(90deg, var(--green-dark), var(--green));
  border-radius:10px;
  transition:width 0.8s ease;
}
.progress-stats{
  display:grid;
  grid-template-columns:repeat(4, 1fr);
  gap:12px;
}
.progress-stat{
  text-align:center;
  padding:12px;
  border-radius:12px;
  background:#F8F9FA;
}
.progress-stat .number{
  font-size:20px;
  font-weight:700;
  margin-bottom:4px;
}
.progress-stat .label{
  font-size:12px;
  color:var(--text-light);
  font-weight:500;
}
.stat-hadir{color:#4caf50}
.stat-sakit{color:#ffeb3b;text-shadow:0 0 1px rgba(0,0,0,0.3)}
.stat-izin{color:#2196f3}
.stat-alpha{color:#f44336}

/* Content Grid */
.content-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
  margin-bottom:20px;
}

/* Jadwal & Absensi Sections */
.section-card{
  background:var(--white);
  border-radius:16px;
  padding:20px;
  box-shadow:var(--shadow);
}
.section-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:16px;
}
.section-header h4{
  font-size:15px;
  color:var(--text-dark);
  font-weight:600;
  display:flex;
  align-items:center;
  gap:8px;
}
.section-count{
  background:var(--orange);
  color:white;
  padding:4px 10px;
  border-radius:10px;
  font-size:12px;
  font-weight:600;
}
.item-list{
  display:flex;
  flex-direction:column;
  gap:10px;
}
.list-item{
  background:#F8F9FA;
  border-radius:12px;
  padding:14px;
  border-left:3px solid var(--orange);
  transition:all 0.3s ease;
}
.list-item:hover{
  background:#F0F0F0;
  transform:translateX(4px);
}
.jadwal-time{
  font-size:13px;
  font-weight:700;
  color:var(--orange);
  margin-bottom:6px;
  font-family:'Courier New',monospace;
}
.jadwal-details{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
}
.jadwal-mapel{
  font-size:14px;
  font-weight:600;
  color:var(--text-dark);
  flex:1;
}
.jadwal-guru{
  font-size:12px;
  color:var(--text-light);
}
.absensi-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.absensi-mapel{
  font-size:14px;
  font-weight:600;
  color:var(--text-dark);
}
.absensi-status{
  padding:6px 12px;
  border-radius:8px;
  font-size:11px;
  font-weight:700;
}
.status-hadir{background:#4caf50;color:white}
.status-sakit{background:#ffeb3b;color:#333}
.status-izin{background:#2196f3;color:white}
.status-alpha{background:#f44336;color:white}

/* Informasi */
.info-section{
  background:var(--white);
  border-radius:16px;
  padding:20px;
  box-shadow:var(--shadow);
  margin-bottom:20px;
}
.info-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:16px;
  cursor:pointer;
}
.info-header h4{
  font-size:15px;
  color:var(--text-dark);
  font-weight:600;
  display:flex;
  align-items:center;
  gap:8px;
}
.info-toggle{
  background:#F8F9FA;
  border:none;
  color:var(--text-dark);
  padding:6px 10px;
  border-radius:8px;
  cursor:pointer;
  font-size:12px;
  transition:all 0.3s ease;
}
.info-toggle:hover{
  background:#E0E0E0;
}
.info-list{
  display:none;
  flex-direction:column;
  gap:10px;
}
.info-list.show{
  display:flex;
}
.info-item{
  padding:14px;
  background:#F8F9FA;
  border-radius:12px;
  border-left:3px solid var(--green-dark);
  transition:all 0.3s ease;
}
.info-item:hover{
  background:#F0F0F0;
  transform:translateX(4px);
}
.info-title{
  font-size:14px;
  font-weight:700;
  color:var(--text-dark);
  margin-bottom:6px;
}
.info-text{
  font-size:13px;
  color:var(--text-light);
  line-height:1.5;
  margin-bottom:6px;
}
.info-meta{
  font-size:11px;
  color:var(--text-light);
  display:flex;
  align-items:center;
  gap:4px;
}

/* Empty state */
.no-data{
  text-align:center;
  padding:40px 20px;
  color:var(--text-light);
}
.no-data i{
  font-size:48px;
  margin-bottom:12px;
  opacity:0.5;
}
.no-data p{
  font-size:14px;
}

/* Responsive */
@media (max-width: 768px){
  .stats-section{
    grid-template-columns:1fr;
  }
  .quick-buttons{
    grid-template-columns:repeat(2, 1fr);
  }
  .content-grid{
    grid-template-columns:1fr;
  }
  .progress-stats{
    grid-template-columns:repeat(2, 1fr);
  }
}

@media (max-width: 480px){
  .header-wrapper{
    padding:20px 16px 50px;
  }
  .header-avatar{
    width:70px;
    height:70px;
    font-size:28px;
  }
  .header-info h3{
    font-size:18px;
  }
  .main-content{
    padding:16px;
  }
  .quick-buttons{
    grid-template-columns:1fr;
  }
  .quick-btn{
    flex-direction:row;
    justify-content:flex-start;
    padding:16px;
  }
  .quick-btn i{
    font-size:24px;
  }
}
</style>
</head>
<body>

<div class="container">
  <!-- Header dengan Kurva -->
  <div class="header-wrapper">
    <div class="header-content">
      <div class="header-avatar">
        <?php if (strpos($foto_path, 'data:image/svg+xml') === 0): ?>
          <img src="<?= $foto_path ?>" alt="Foto Profil">
        <?php else: ?>
          <img src="<?= $foto_path ?>" alt="Foto Profil" onerror="this.src='data:image/svg+xml;base64,<?= base64_encode('<svg width=\"100\" height=\"100\" xmlns=\"http://www.w3.org/2000/svg\"><rect width=\"100\" height=\"100\" fill=\"#2196F3\"/><text x=\"50\" y=\"55\" font-family=\"Arial\" font-size=\"40\" fill=\"white\" text-anchor=\"middle\" dominant-baseline=\"middle\">' . strtoupper(substr($siswa_nama, 0, 1)) . '</text></svg>') ?>'">
        <?php endif; ?>
      </div>
      <div class="header-info">
        <h3><?= htmlspecialchars($siswa_nama) ?></h3>
        <p><?= htmlspecialchars($siswa_kelas) ?></p>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    
    <!-- Stats Cards -->
    <div class="stats-section">
      <div class="stat-card">
        <div class="stat-icon green">
          <i class="fas fa-user-check"></i>
        </div>
        <div class="stat-content">
          <h4>Hadir Bulan Ini</h4>
          <p><?= $hadir_bulan ?> / <?= $total_kehadiran ?> Hari</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon orange">
          <i class="fas fa-book"></i>
        </div>
        <div class="stat-content">
          <h4>Mata Pelajaran</h4>
          <p><?= $total_mapel ?> Mapel</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon blue">
          <i class="fas fa-calendar-day"></i>
        </div>
        <div class="stat-content">
          <h4>Jadwal Hari Ini</h4>
          <p><?= count($jadwal_hari_ini) ?> Kelas</p>
        </div>
      </div>
    </div>

    <!-- Urgent Info -->
    <?php if (count($informasi_list) > 0): ?>
      <?php $first_info = $informasi_list[0]; ?>
      <div class="urgent-info">
        <h3>URGENT INFO</h3>
        <p><strong><?= htmlspecialchars($first_info['judul']) ?></strong></p>
        <p><?= htmlspecialchars(substr($first_info['isi'], 0, 100)) ?><?= strlen($first_info['isi']) > 100 ? '...' : '' ?></p>
      </div>
    <?php endif; ?>

    <!-- Quick Access -->
    <div class="quick-access">
      <h3>Quick Access</h3>
      <div class="quick-buttons">
        <a href="jadwal.php" class="quick-btn green">
          <i class="fas fa-calendar-alt"></i>
          <span>Jadwal</span>
        </a>
        <a href="absenfull.php" class="quick-btn orange">
          <i class="fas fa-clipboard-check"></i>
          <span>Riwayat</span>
        </a>
        <a href="notifikasi.php" class="quick-btn blue">
          <i class="fas fa-bell"></i>
          <span>Notifikasi</span>
        </a>
      </div>
    </div>

    <!-- Progress Kehadiran -->
    <div class="progress-container">
      <div class="progress-header">
        <h4><i class="fas fa-chart-line"></i> Kehadiran Bulan Ini</h4>
        <div class="progress-percentage"><?= $persentase_hadir ?>%</div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" style="width: <?= $persentase_hadir ?>%"></div>
      </div>
      <div class="progress-stats">
        <div class="progress-stat">
          <div class="number stat-hadir"><?= $hadir_bulan ?></div>
          <div class="label">Hadir</div>
        </div>
        <div class="progress-stat">
          <div class="number stat-sakit"><?= $sakit_bulan ?></div>
          <div class="label">Sakit</div>
        </div>
        <div class="progress-stat">
          <div class="number stat-izin"><?= $izin_bulan ?></div>
          <div class="label">Izin</div>
        </div>
        <div class="progress-stat">
          <div class="number stat-alpha"><?= $alpha_bulan ?></div>
          <div class="label">Alpha</div>
        </div>
      </div>
    </div>

    <!-- Jadwal & Absensi Grid -->
    <div class="content-grid">
      <!-- Jadwal Hari Ini -->
      <div class="section-card">
        <div class="section-header">
          <h4><i class="fas fa-clock"></i> Jadwal Hari Ini</h4>
          <div class="section-count"><?= count($jadwal_hari_ini) ?></div>
        </div>
        <div class="item-list">
          <?php if (count($jadwal_hari_ini) > 0): ?>
            <?php foreach ($jadwal_hari_ini as $jadwal): ?>
              <div class="list-item">
                <div class="jadwal-time">
                  <?= date('H:i', strtotime($jadwal['jam_mulai'])) ?> - <?= date('H:i', strtotime($jadwal['jam_selesai'])) ?>
                </div>
                <div class="jadwal-details">
                  <div class="jadwal-mapel"><?= htmlspecialchars($jadwal['nama_mapel']) ?></div>
                  <div class="jadwal-guru"><?= htmlspecialchars($jadwal['nama_guru']) ?></div>
                </div>
              </div>
            <?php endforeach; ?>
          <?php else: ?>
            <div class="no-data">
              <i class="fas fa-calendar-times"></i>
              <p>Tidak ada jadwal</p>
            </div>
          <?php endif; ?>
        </div>
      </div>

      <!-- Absensi Hari Ini -->
      <div class="section-card">
        <div class="section-header">
          <h4><i class="fas fa-clipboard-check"></i> Absensi Hari Ini</h4>
        </div>
        <div class="item-list">
          <?php if (count($absensi_hari_ini) > 0): ?>
            <?php foreach ($absensi_hari_ini as $absensi): ?>
              <div class="list-item absensi-item">
                <div class="absensi-mapel"><?= htmlspecialchars($absensi['nama_mapel']) ?></div>
                <div class="absensi-status status-<?= strtolower($absensi['status']) ?>">
                  <?= $absensi['status'] ?>
                </div>
              </div>
            <?php endforeach; ?>
          <?php else: ?>
            <div class="no-data">
              <i class="fas fa-clipboard-list"></i>
              <p>Belum ada absensi</p>
            </div>
          <?php endif; ?>
        </div>
      </div>
    </div>

    <!-- Informasi Section -->
    <div class="info-section">
      <div class="info-header" onclick="toggleInformasi()">
        <h4><i class="fas fa-info-circle"></i> Informasi Terbaru</h4>
        <button class="info-toggle">
          <i class="fas fa-chevron-down"></i>
        </button>
      </div>
      
      <div class="info-list" id="informasiList">
        <?php if (count($informasi_list) > 0): ?>
          <?php foreach ($informasi_list as $info): ?>
            <div class="info-item">
              <div class="info-title">
                <?= htmlspecialchars($info['judul']) ?>
              </div>
              <div class="info-text">
                <?= nl2br(htmlspecialchars($info['isi'])) ?>
              </div>
              <div class="info-meta">
                <i class="fas fa-clock"></i>
                <?= date('d/m/Y H:i', strtotime($info['tanggal'])) ?>
              </div>
            </div>
          <?php endforeach; ?>
        <?php
          <?php endforeach; ?>
        <?php else: ?>
          <div class="no-data">
            <i class="fas fa-info-circle"></i>
            <p>Tidak ada informasi terbaru</p>
          </div>
        <?php endif; ?>
      </div>
    </div>

    <!-- Footer / Quick Links -->
    <div style="margin-top:20px; text-align:center; color:var(--text-light); font-size:13px;">
      <p>© <?= date('Y') ?> SDIT — Sistem Informasi Siswa</p>
      <p>
        <a href="../logout.php" style="color:var(--orange); text-decoration:none; font-weight:600;">Logout</a>
      </p>
    </div>

  </div> <!-- end .main-content -->
</div> <!-- end .container -->

<script>
  // Toggle untuk bagian informasi
  function toggleInformasi() {
    const list = document.getElementById('informasiList');
    const toggleBtn = document.querySelector('.info-toggle i');
    if (!list) return;

    list.classList.toggle('show');
    // Putar icon
    if (list.classList.contains('show')) {
      toggleBtn.classList.remove('fa-chevron-down');
      toggleBtn.classList.add('fa-chevron-up');
    } else {
      toggleBtn.classList.remove('fa-chevron-up');
      toggleBtn.classList.add('fa-chevron-down');
    }
  }

  // Pastikan progress bar sesuai (fallback jika inline style belum diaplikasikan)
  document.addEventListener('DOMContentLoaded', function() {
    const fill = document.querySelector('.progress-fill');
    if (fill) {
      const pctText = <?= json_encode($persentase_hadir) ?>;
      // jaga agar antara 0-100
      let pct = Number(pctText);
      if (isNaN(pct) || pct < 0) pct = 0;
      if (pct > 100) pct = 100;
      fill.style.width = pct + '%';
    }

    // Jika ingin auto-expand informasi bila ada urgent info, uncomment:
    // const infoList = document.getElementById('informasiList');
    // if (infoList && infoList.children.length > 0) infoList.classList.add('show');
  });

  // Optional: tangani error loading gambar profil (double-guard)
  document.querySelectorAll('.header-avatar img').forEach(img => {
    img.addEventListener('error', function() {
      this.src = 'data:image/svg+xml;base64,<?= base64_encode('<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="100" fill="#2196F3"/><text x="50" y="55" font-family="Arial" font-size="40" fill="white" text-anchor="middle" dominant-baseline="middle">'. strtoupper(substr($siswa_nama,0,1)) .'</text></svg>') ?>';
    });
  });
</script>

</body>
</html>
